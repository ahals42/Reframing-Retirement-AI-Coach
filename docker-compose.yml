services:
  qdrant:
    image: qdrant/qdrant:v1.16.3
    container_name: qdrant
    # SECURITY: Bind to localhost only (not exposed externally)
    # Remove the ports section entirely to keep Qdrant internal to Docker network
    # If you need local access for debugging, use: "127.0.0.1:6333:6333"
    # ports:
    #   - "127.0.0.1:6333:6333"  # Bind to localhost only
    volumes:
      - qdrant_storage:/qdrant/storage
    restart: unless-stopped
    # SECURITY: Enable Qdrant API key authentication (optional but recommended)
    environment:
      # Uncomment and set QDRANT_API_KEY in your environment to enable auth
      # - QDRANT__SERVICE__API_KEY=${QDRANT_API_KEY}
      - QDRANT__SERVICE__GRPC_PORT=6334
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  api:
    build: .
    container_name: api
    ports:
      - "8000:8000"
    # SECURITY: Do not use env_file - pass environment variables explicitly
    # This prevents accidentally exposing .env file in the container
    environment:
      # REQUIRED: OpenAI API key (pass from host environment or secrets manager)
      - OPENAI_API_KEY=${OPENAI_API_KEY}

      # REQUIRED: API keys for authentication (comma-separated list)
      - API_KEYS=${API_KEYS}

      # REQUIRED: CORS allowed origins (comma-separated list)
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:8000,http://127.0.0.1:8000}

      # Qdrant configuration (internal Docker network)
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - QDRANT_API_KEY=${QDRANT_API_KEY:-}

      # Rate limiting configuration
      - RATE_LIMIT_MESSAGES_PER_HOUR=${RATE_LIMIT_MESSAGES_PER_HOUR:-100}
      - RATE_LIMIT_VOICE_CONCURRENT=${RATE_LIMIT_VOICE_CONCURRENT:-10}
      - MAX_SESSIONS_PER_API_KEY=${MAX_SESSIONS_PER_API_KEY:-50}

      # Input validation limits
      - MAX_MESSAGE_LENGTH=${MAX_MESSAGE_LENGTH:-10000}
      - MAX_AUDIO_SIZE_MB=${MAX_AUDIO_SIZE_MB:-10}
      - MAX_HISTORY_MESSAGES=${MAX_HISTORY_MESSAGES:-100}

      # Session management
      - SESSION_TTL_MINUTES=${SESSION_TTL_MINUTES:-90}

      # Security settings
      - FORCE_HTTPS=${FORCE_HTTPS:-false}
      - ENABLE_JSON_LOGGING=${ENABLE_JSON_LOGGING:-true}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      qdrant:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  qdrant_storage:
